#include <Adafruit_NeoPixel.h>
#ifdef __AVR__
#include <avr/power.h>
#endif

// --- HARDWARE & PIN DEFINITIONS ---
#define LED_PIN     6
#define LED_COUNT   256
#define BRIGHTNESS  5

Adafruit_NeoPixel strip(LED_COUNT, LED_PIN, NEO_GRB + NEO_KHZ800);

// --- LED Matrix and Section Definitions ---
#define MATRIX_SIZE 16         // 16x16 grid = 256 pixels
#define NUM_SECTIONS_PER_SIDE 3 // 3x3 grid = 9 sections total

// Base dimensions for the 3x3 grid sections (5x5, 5x6, 6x5, 6x6)
const int BASE_ROWS = MATRIX_SIZE / NUM_SECTIONS_PER_SIDE; // 16 / 3 = 5
const int LAST_ROWS = MATRIX_SIZE - (BASE_ROWS * 2);       // 16 - 10 = 6 

// --- Color Enumeration and Mapping ---

// Define the named colors as constants
enum NamedColors {
    COLOR_RED,
    COLOR_GREEN,
    COLOR_BLUE,
    COLOR_YELLOW,
    COLOR_CYAN,
    COLOR_MAGENTA,
    COLOR_WHITE,
    COLOR_BLACK // Turns the section off
};

// ------------------------------------------------------------------
// --- HELPER FUNCTIONS ---
// ------------------------------------------------------------------

// Helper function to convert the NamedColor enum to a 32-bit color value
uint32_t getColorValue(NamedColors color) {
    switch (color) {
        case COLOR_RED:
            return strip.Color(255, 0, 0);
        case COLOR_GREEN:
            return strip.Color(0, 255, 0);
        case COLOR_BLUE:
            return strip.Color(0, 0, 255);
        case COLOR_YELLOW:
            return strip.Color(255, 255, 0);
        case COLOR_CYAN:
            return strip.Color(0, 255, 255);
        case COLOR_MAGENTA:
            return strip.Color(255, 0, 255);
        case COLOR_WHITE:
            return strip.Color(255, 255, 255);
        case COLOR_BLACK:
            return strip.Color(0, 0, 0);
        default:
            return strip.Color(0, 0, 0);
    }
}

// Function to convert 2D (x,y) coordinates to 1D NeoPixel index
// ASSUMES SERPENTINE WIRING: Even rows L->R, Odd rows R->L.
int xyToStripIndex(int x, int y) {
  if (y % 2 == 0) { 
    return y * MATRIX_SIZE + x;
  } else { 
    return (y + 1) * MATRIX_SIZE - 1 - x;
  }
}

// Sets a specific square section (1-9) to a single color using the enum
void setSectionColor(int sectionNumber, NamedColors color) {
    // There are 9 sections (1-9)
    if (sectionNumber < 1 || sectionNumber > 9) return;

    // 1. Convert Section Number (1-9) to Grid Coordinates (row 0-2, col 0-2)
    int sectionRow = (sectionNumber - 1) / NUM_SECTIONS_PER_SIDE; // 0, 1, or 2
    int sectionCol = (sectionNumber - 1) % NUM_SECTIONS_PER_SIDE; // 0, 1, or 2

    // 2. Determine Start/End Coordinates for this Section

    // Y-Coordinates (Rows)
    int startY, endY;
    if (sectionRow < 2) {
        startY = sectionRow * BASE_ROWS;
        endY = startY + BASE_ROWS;
    } else { // Last row (Section 7, 8, 9) gets the extra 6 pixels
        startY = 2 * BASE_ROWS;
        endY = startY + LAST_ROWS; // endY will be 16
    }

    // X-Coordinates (Columns)
    int startX, endX;
    if (sectionCol < 2) {
        startX = sectionCol * BASE_ROWS;
        endX = startX + BASE_ROWS;
    } else { // Last column (Section 3, 6, 9) gets the extra 6 pixels
        startX = 2 * BASE_ROWS;
        endX = startX + LAST_ROWS; // endX will be 16
    }
    
    // 3. Apply Color to Pixels
    uint32_t packedColor = getColorValue(color);

    // Nested loop iterates through the calculated square boundaries
    for (int y = startY; y < endY; y++) {
        for (int x = startX; x < endX; x++) {
            int i = xyToStripIndex(x, y); // Convert 2D coord to 1D strip index
            strip.setPixelColor(i, packedColor);
        }
    }
}

// ------------------------------------------------------------------
// --- MAIN PROGRAM FLOW ---
// ------------------------------------------------------------------

void setup() {
    Serial.begin(115200);
    Serial.println("Matrix Section Control Ready.");

    #if defined(__AVR_ATtiny85__) && (F_CPU == 16000000)
      clock_prescale_set(clock_div_1);
    #endif

    strip.begin();
    strip.show(); // Turn off all pixels initially
    strip.setBrightness(BRIGHTNESS);
}

void loop() {
    // --- DEMONSTRATION 1: Chessboard Pattern ---
    strip.clear(); 
    
    // Set sections in a checkerboard pattern
    for (int i = 1; i <= 9; i++) {
        // Sections 1, 3, 5, 7, 9 -> White
        if (i % 2 != 0) { 
            setSectionColor(i, COLOR_WHITE); 
        } 
        // Sections 2, 4, 6, 8 -> Blue
        else {
            setSectionColor(i, COLOR_BLUE);
        }
    }
    strip.show();
    delay(2000); 

    // --- DEMONSTRATION 2: Color Gradient (Rows) ---
    strip.clear();
    
    // Row 1 (Sections 1, 2, 3) -> Red
    setSectionColor(1, COLOR_RED);
    setSectionColor(2, COLOR_RED);
    setSectionColor(3, COLOR_RED);

    // Row 2 (Sections 4, 5, 6) -> Green
    setSectionColor(4, COLOR_GREEN);
    setSectionColor(5, COLOR_GREEN);
    setSectionColor(6, COLOR_GREEN);
    
    // Row 3 (Sections 7, 8, 9) -> Yellow
    setSectionColor(7, COLOR_YELLOW);
    setSectionColor(8, COLOR_YELLOW);
    setSectionColor(9, COLOR_YELLOW);
    
    strip.show();
    delay(2000);
}
